name: 'Rain Web'
on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
        types:
            - opened
            - synchronize
            - closed

jobs:
    build-for-production:
        runs-on: ubuntu-latest
        env:
            VITE_DATABASE_URL: ${{ secrets.DATABASE_URL }}
            VITE_DIRECT_URL: ${{ secrets.DIRECT_URL }}
            VITE_ALLOW_ORIGIN: ${{ secrets.ALLOW_ORIGIN }}
            VITE_R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
            VITE_R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
            VITE_R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
            VITE_R2_BNR_BUCKETNAME: ${{ secrets.R2_BNR_BUCKETNAME }}
            VITE_R2_BNR_UNIQUE_URL: ${{ secrets.R2_BNR_UNIQUE_URL }}

        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Install Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 16

            - uses: pnpm/action-setup@v2
              name: Install pnpm
              id: pnpm-install
              with:
                  version: 7
                  run_install: false

            - name: Install dependencies
              run: pnpm i
            - run: npx prisma generate --schema=./prisma/schema.prisma --no-engine

            - name: Build
              run: pnpm build

            - name: Deploy on Cloudflare Production
              if: github.event_name == 'push' || github.event.pull_request.merged
              uses: cloudflare/wrangler-action@2.0.0
              with:
                  apiToken: ${{ secrets.CF_API_TOKEN }}
                  accountId: ${{ secrets.CF_ACCOUNT_ID }}
                  command: deploy --name production
